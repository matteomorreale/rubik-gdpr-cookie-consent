<!DOCTYPE html>
<html>
<head>
    <title>Test Syntax Consent Retention</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f1; }
        .test-section { background: white; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { color: #00a32a; }
        .error { color: #d63638; }
        .info { color: #0073aa; }
        button { background: #0073aa; color: white; padding: 10px 15px; border: none; border-radius: 3px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
        .result { margin-top: 10px; padding: 10px; border-radius: 3px; display: none; }
    </style>
</head>
<body>
    <h1>üß™ Test Syntax GDPR Consent Retention</h1>
    
    <div class="test-section">
        <h3>Test Syntax JavaScript</h3>
        <p>Questo test verifica che il JavaScript generato sia sintatticamente corretto.</p>
        
        <button onclick="testAjaxSyntax()">Test AJAX Syntax</button>
        <button onclick="testErrorHandling()">Test Error Handling</button>
        <button onclick="testStringInterpolation()">Test String Interpolation</button>
        
        <div id="test-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>Test Simulazione AJAX</h3>
        <p>Simula le richieste AJAX che potrebbero essere eseguite dall'admin.</p>
        
        <button onclick="simulateAllDelete()">Simula Cancellazione Totale</button>
        <button onclick="simulateExpiredDelete()">Simula Cancellazione Scaduti</button>
        
        <div id="ajax-result" class="result"></div>
    </div>

    <script>
        // Simula l'oggetto manus_gdpr_admin_ajax che dovrebbe essere disponibile in WordPress
        window.manus_gdpr_admin_ajax = {
            ajax_url: '/wp-admin/admin-ajax.php',
            nonce: 'test_nonce_123456'
        };

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
            element.style.display = 'block';
        }

        function testAjaxSyntax() {
            showResult('test-result', 'üîÑ Testing AJAX syntax...', 'info');
            
            try {
                // Simula il codice AJAX che viene generato dal PHP
                const testFunction = function(type) {
                    const resultDiv = document.createElement('div');
                    const buttons = document.querySelectorAll('button');
                    
                    // Disable buttons
                    buttons.forEach(btn => btn.disabled = true);
                    
                    // Show loading
                    resultDiv.style.display = "block";
                    resultDiv.innerHTML = "<p style=\"color: #0073aa;\">‚è≥ Cancellazione in corso...</p>";
                    
                    // Simulate AJAX request
                    fetch(manus_gdpr_admin_ajax.ajax_url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: new URLSearchParams({
                            action: "manus_gdpr_clear_consents",
                            type: type,
                            nonce: manus_gdpr_admin_ajax.nonce
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            resultDiv.innerHTML = "<p style=\"color: #00a32a;\">‚úÖ " + data.data + "</p>";
                            setTimeout(() => location.reload(), 2000);
                        } else {
                            resultDiv.innerHTML = "<p style=\"color: #d63638;\">‚ùå " + (data.data || "Errore durante la cancellazione") + "</p>";
                        }
                    })
                    .catch(error => {
                        resultDiv.innerHTML = "<p style=\"color: #d63638;\">‚ùå Errore di comunicazione - " + error.message + "</p>";
                    })
                    .finally(() => {
                        // Re-enable buttons
                        buttons.forEach(btn => btn.disabled = false);
                    });
                };

                // Test the function
                testFunction('all');
                
                showResult('test-result', '‚úÖ AJAX syntax test passed! No syntax errors detected.', 'success');
            } catch (error) {
                showResult('test-result', `‚ùå Syntax error detected: ${error.message}`, 'error');
            }
        }

        function testErrorHandling() {
            showResult('test-result', 'üîÑ Testing error handling...', 'info');
            
            try {
                // Test string interpolation that was causing the issue
                const errorMessage = "Errore di comunicazione";
                const testError = new Error("Sample error");
                
                // This was the problematic line: 
                // resultDiv.innerHTML = "<p>‚ùå " + errorMessage + ": " + error.message + "</p>";
                // Fixed to:
                const fixedMessage = "<p>‚ùå " + errorMessage + " - " + testError.message + "</p>";
                
                showResult('test-result', '‚úÖ Error handling test passed! String interpolation works correctly.', 'success');
            } catch (error) {
                showResult('test-result', `‚ùå Error handling test failed: ${error.message}`, 'error');
            }
        }

        function testStringInterpolation() {
            showResult('test-result', 'üîÑ Testing string interpolation...', 'info');
            
            try {
                // Test various string combinations that might cause issues
                const tests = [
                    'Simple string',
                    'String with: colon',
                    'String with "quotes"',
                    "String with 'apostrophes'",
                    'String with mixed: "quotes" and \'apostrophes\'',
                    'String with numbers: 123',
                    'String with special chars: ‚Ç¨@#$%^&*()'
                ];

                let allPassed = true;
                for (const test of tests) {
                    try {
                        const result = "<p>Test: " + test + "</p>";
                        if (!result.includes(test)) {
                            allPassed = false;
                        }
                    } catch (e) {
                        allPassed = false;
                        break;
                    }
                }

                if (allPassed) {
                    showResult('test-result', '‚úÖ String interpolation test passed! All string combinations work.', 'success');
                } else {
                    showResult('test-result', '‚ùå String interpolation test failed!', 'error');
                }
            } catch (error) {
                showResult('test-result', `‚ùå String interpolation test failed: ${error.message}`, 'error');
            }
        }

        function simulateAllDelete() {
            showResult('ajax-result', 'üîÑ Simulating total consent deletion...', 'info');
            
            setTimeout(() => {
                // Simulate successful response
                const mockResponse = {
                    success: true,
                    data: "Cancellati 25 consensi."
                };
                
                showResult('ajax-result', `‚úÖ Simulation complete: ${mockResponse.data}`, 'success');
            }, 1000);
        }

        function simulateExpiredDelete() {
            showResult('ajax-result', 'üîÑ Simulating expired consent deletion...', 'info');
            
            setTimeout(() => {
                // Simulate successful response
                const mockResponse = {
                    success: true,
                    data: "Cancellati 8 consensi scaduti (pi√π vecchi di 365 giorni)."
                };
                
                showResult('ajax-result', `‚úÖ Simulation complete: ${mockResponse.data}`, 'success');
            }, 1500);
        }

        // Auto-run syntax test on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                showResult('test-result', 'üîÑ Running automatic syntax check...', 'info');
                setTimeout(testAjaxSyntax, 500);
            }, 1000);
        });
    </script>
</body>
</html>
